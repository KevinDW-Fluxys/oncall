{
  "description": "OnCall Dev SMS Paging",
  "states": [
    {
      "name": "Trigger",
      "type": "trigger",
      "transitions": [
        {
          "next": "escalate_trigger",
          "event": "incomingMessage"
        },
        {
          "event": "incomingCall"
        },
        {
          "event": "incomingConversationMessage"
        },
        {
          "event": "incomingRequest"
        },
        {
          "event": "incomingParent"
        }
      ],
      "properties": {
        "offset": {
          "x": 30,
          "y": 80
        }
      }
    },
    {
      "name": "send_escalation",
      "type": "make-http-request",
      "transitions": [
        {
          "next": "send_escalation_success",
          "event": "success"
        },
        {
          "next": "send_escalation_failed",
          "event": "failed"
        }
      ],
      "properties": {
        "offset": {
          "x": 70,
          "y": 1360
        },
        "method": "POST",
        "content_type": "application/json;charset=utf-8",
        "body": "{\"target\":\"{{widgets.select_target.inbound.Body}}\", \"from\":\"{{trigger.message.From}}\", \"message\":\"{{widgets.describe_alert.inbound.Body}}\",\"sid\": \"{{flow.sid}}\" , \"flow_sid\":\"{{flow.flow_sid}}\"}",
        "url": "https://rude-teams-boil.loca.lt/twilioapp/escalate/"
      }
    },
    {
      "name": "escalate_trigger",
      "type": "split-based-on",
      "transitions": [
        {
          "next": "unrecognized_command",
          "event": "noMatch"
        },
        {
          "next": "get_targets",
          "event": "match",
          "conditions": [
            {
              "friendly_name": "If value contains alert",
              "arguments": ["{{trigger.message.Body}}"],
              "type": "contains",
              "value": "escalate"
            }
          ]
        }
      ],
      "properties": {
        "input": "{{trigger.message.Body}}",
        "offset": {
          "x": 30,
          "y": 330
        }
      }
    },
    {
      "name": "unrecognized_command",
      "type": "send-message",
      "transitions": [
        {
          "event": "sent"
        },
        {
          "event": "failed"
        }
      ],
      "properties": {
        "offset": {
          "x": -220,
          "y": 560
        },
        "service": "{{trigger.message.InstanceSid}}",
        "channel": "{{trigger.message.ChannelSid}}",
        "from": "{{flow.channel.address}}",
        "message_type": "custom",
        "to": "{{contact.channel.address}}",
        "body": "\"{{trigger.message.Body}}\" does not contain a recognized command."
      }
    },
    {
      "name": "get_targets",
      "type": "make-http-request",
      "transitions": [
        {
          "next": "select_target",
          "event": "success"
        },
        {
          "next": "no_valid_targets",
          "event": "failed"
        }
      ],
      "properties": {
        "offset": {
          "x": 400,
          "y": 550
        },
        "method": "POST",
        "content_type": "application/json;charset=utf-8",
        "body": "{\"from\":\"{{trigger.message.From}}\", \"sid\": \"{{flow.sid}}\" , \"flow_sid\":\"{{flow.flow_sid}}\"}",
        "url": "https://rude-teams-boil.loca.lt/twilioapp/get_escalation_targets/"
      }
    },
    {
      "name": "no_valid_targets",
      "type": "send-message",
      "transitions": [
        {
          "event": "sent"
        },
        {
          "event": "failed"
        }
      ],
      "properties": {
        "offset": {
          "x": 680,
          "y": 840
        },
        "service": "{{trigger.message.InstanceSid}}",
        "channel": "{{trigger.message.ChannelSid}}",
        "from": "{{flow.channel.address}}",
        "message_type": "custom",
        "to": "{{contact.channel.address}}",
        "body": "There are no available teams or integrations to escalate to. ({{widgets.get_targets.status_code}})"
      }
    },
    {
      "name": "select_target",
      "type": "send-and-wait-for-reply",
      "transitions": [
        {
          "next": "describe_alert",
          "event": "incomingMessage"
        },
        {
          "next": "select_target_start_over",
          "event": "timeout"
        },
        {
          "event": "deliveryFailure"
        }
      ],
      "properties": {
        "offset": {
          "x": 70,
          "y": 790
        },
        "service": "{{trigger.message.InstanceSid}}",
        "channel": "{{trigger.message.ChannelSid}}",
        "from": "{{flow.channel.address}}",
        "message_type": "custom",
        "body": "{{widgets.get_targets.parsed.message}}",
        "timeout": "300"
      }
    },
    {
      "name": "select_target_start_over",
      "type": "send-message",
      "transitions": [
        {
          "event": "sent"
        },
        {
          "event": "failed"
        }
      ],
      "properties": {
        "offset": {
          "x": 660,
          "y": 1230
        },
        "service": "{{trigger.message.InstanceSid}}",
        "channel": "{{trigger.message.ChannelSid}}",
        "from": "{{flow.channel.address}}",
        "message_type": "custom",
        "to": "{{contact.channel.address}}",
        "body": "Selection timed out. Send \"escalate\" to start again."
      }
    },
    {
      "name": "describe_alert",
      "type": "send-and-wait-for-reply",
      "transitions": [
        {
          "next": "send_escalation",
          "event": "incomingMessage"
        },
        {
          "next": "select_target_start_over",
          "event": "timeout"
        },
        {
          "event": "deliveryFailure"
        }
      ],
      "properties": {
        "offset": {
          "x": 70,
          "y": 1110
        },
        "service": "{{trigger.message.InstanceSid}}",
        "channel": "{{trigger.message.ChannelSid}}",
        "from": "{{flow.channel.address}}",
        "message_type": "custom",
        "body": "Provide a description for the escalation",
        "timeout": "600"
      }
    },
    {
      "name": "send_escalation_failed",
      "type": "send-message",
      "transitions": [
        {
          "event": "sent"
        },
        {
          "event": "failed"
        }
      ],
      "properties": {
        "offset": {
          "x": 660,
          "y": 1560
        },
        "service": "{{trigger.message.InstanceSid}}",
        "channel": "{{trigger.message.ChannelSid}}",
        "from": "{{flow.channel.address}}",
        "message_type": "custom",
        "to": "{{contact.channel.address}}",
        "body": "Failed to send escalation ({{widgets.send_escalation.status_code}})"
      }
    },
    {
      "name": "send_escalation_success",
      "type": "send-message",
      "transitions": [
        {
          "event": "sent"
        },
        {
          "event": "failed"
        }
      ],
      "properties": {
        "offset": {
          "x": 80,
          "y": 1690
        },
        "service": "{{trigger.message.InstanceSid}}",
        "channel": "{{trigger.message.ChannelSid}}",
        "from": "{{flow.channel.address}}",
        "message_type": "custom",
        "to": "{{contact.channel.address}}",
        "body": "Escalation sent successfully"
      }
    }
  ],
  "initial_state": "Trigger",
  "flags": {
    "allow_concurrent_calls": true
  }
}
